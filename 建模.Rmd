---
title: "美国金县房价影响因素探究"
author: 林恒基 2018201708，李政萱 2018201700，董钦源 2018201653，孙雨忱 2018201169，张雯丽 2018200701，曹竞轩 2018202075
output:
  html_document:
    toc: true
    toc_float: true
    fig_caption: true
    theme: flatly
    css: styles.css
---

```{r setup, include=FALSE}
library(knitr)
library(car)
library(zoo)
library(lmtest)
library(MASS)
opts_knit$set(root.dir = "/Users/caojingxuan/Desktop/回归分析/小组作业/数据")
opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, tidy = TRUE)
```

```{r}
regression.diagnostics <- function(fit) {
  par(mfrow = c(2, 3))
  plot(fit, which = 1:5)
  influencePlot(fit)
  
  cat("异常值/强影响点检验\n")
  print(outlierTest(fit))
  
  cat("\n异方差检验\n")
  print(ncvTest(fit))
  print(bptest(fit))
  print(gqtest(fit))
  
  cat("\n共线性检验\n")
  print(vif(fit))
  
  cat("\n自相关检验\n")
  print(durbinWatsonTest(fit))
}
```

***

# 数据准备

## 数据来源

### 来源与背景

本工作中使用的数据来自于Kaggle上的数据集[House Sales in King County, USA](https://www.kaggle.com/harlfoxem/housesalesprediction)，其中包括了金县从2014年5月到2015年5月的房屋销售数据。

金县是美国华盛顿州的一个县，县都西雅图。县人口约220万人，是华盛顿州最大的县，也是美国第13大县。

### 原始变量说明

1. 交易编号：该次房屋交易行为的独特编号。
2. 销售时间：房产被售出的具体时间（精确到日）。
3. 销售价格：房产的销售价格，单位美元。
4. 卧室数：房产的卧室数量。
5. 浴室数：房产的浴室数量（0.5代表卧室旁附带的浴室，只有厕所没有淋浴设施）。
6. 居住面积：房产的居住面积（地上加地下），单位平方英尺。
7. 土地面积：房产附带的土地面积，如花园、车库、耕地等，单位平方英尺。
8. 楼层数：房产的楼层数（0.5代表阁楼）。
9. 是否海景房：房产是否是海景房。
10. 视野：房产的视野等级，即房周围的景色是否好看。取值0～4，数值越高代表视野越好。
11. 成色：房产的成色，即“几成新”。取值1～5，数值越高代表越新，越低代表越破旧。
12. 建筑设计水平：房产的建筑设计水平，由专家审定，评判标准包括如房间结构的划分、窗户的朝向等是否合理。取值1～13，数值越高代表设计水平越高。
13. 地上建筑面积：房产地上部分的面积，单位平方英尺。
14. 地下建筑面积：房产地下部分的面积，即地下室面积，没有地下室则取0，单位平方英尺。
15. 建筑年份：房产的建筑年份。
16. 翻新年份：房产的翻修年份，若未翻修过则为0。
17. 邮编：房产所处地区的邮编。
18. 纬度：房产所处的纬度。
19. 经度：房产所处的经度。
20. 附近15间房屋平均居住面积：房产附近15间房屋的平均居住面积。
21. 附近15间房屋平均土地面积：房产附近15间房屋的平均土地面积。

***

## 数据清洗

1. 检测并去除含空值的个别样本。
2. 去除一个卧室数为33的异常样本。
3. 去除少量土地面积大于10000平方英尺的异常样本。
4. 去除少量地上建筑面积加上地下建筑面积不等于居住面积的异常样本。

***

## 变量初步筛选

1. 去除交易编号、邮编，由于其作为数值型变量无解释意义。
2. 去除翻新年份。由于未翻新的房产该变量取0，翻新过的房产该变量取翻新年份，故该变量同样作为数值型变量无解释意义。
3. 去除附近15间房屋平均居住面积和附近15间房屋平均土地面积，由于其分别和居住面积和土地面积高度相关。
4. 去除地上建筑面积和地下建筑面积。一是因为它们的和就等于居住面积，存在完全共线性；二是因为地下建筑面积存在大量为0的值（即没有地下室）。与翻新年份同理，不具有解释意义。

***

## 特征提取

#### 每间卧室平均浴室数

在描述性统计中发现，卧室数和浴室数均与居住面积高度相关，故去除这两个变量并加入该衍生变量，其值等于卧室数除以浴室数。经检验该变量与居住面积相关性较低。

#### 有无地下室

从地下建筑面积一列中提取该衍生变量，地下建筑面积为0说明无地下室，否则说明有地下室。

#### 销售年份、销售季度

这两个衍生变量由原变量“销售时间”中提取而来。同时删去原变量。

#### 是否位于西雅图

原数据中“邮编”一栏内的邮编主要由981或980开头，少量是由其他字串开头。经查阅美国邮编规律相关资料得知，981开头的邮编主要对应西雅图辖内地区，其他则对应金县的其他地区（仅有少量例外）。故据此提取该衍生变量。

#### 最近一次翻新距今年份

该衍生变量等于购买年份减去最近一次修建或翻新的年份。例如，购买年份2015，建筑年份1995，翻新年份0（未翻新），则该衍生变量的值为2015 - 1995 = 20。

#### 距最近优质啤酒厂的距离

通过经纬度，结合当地的地图信息计算而得。选取了当地的6个名气大的啤酒厂，计算每间房产离这6个啤酒厂的最近距离，单位英里。这个变量的解释意义为，当地啤酒厂附近通常会有很多餐厅和酒吧等，属于比较繁华的地区。

![距最近优质啤酒厂的距离](https://tva1.sinaimg.cn/large/0081Kckwgy1glugjrfa38j30em0elgsb.jpg)

#### 距医院的交通距离

通过经纬度，结合当地的地图信息计算而得。结合当地的道路信息，计算每间房产离华盛顿大学医学中心（University of Washington Medical Center）的交通距离，单位小时。

![距医院的交通距离](https://tva1.sinaimg.cn/large/0081Kckwgy1glugjqij64j30df0h8agn.jpg)

#### 是否邻近海岸

通过经纬度，结合当地的地图信息计算而得。计算每间房产离最近的海岸线的垂直距离，并将距离小于0.25英里的房产标记为“邻近海岸”，其他标记为“不邻近海岸”。由于原变量“是否海景房”只判断房产的网页上是否加了“海景”标签，因此漏掉了一些在海边但未打上标签的房子，导致大部分取值为0。这里删去它，用新的衍生变量替代之。

![是否海景房](https://tva1.sinaimg.cn/large/0081Kckwgy1glugkevulzj30dn0gfwlg.jpg)

![是否邻近海岸](https://tva1.sinaimg.cn/large/0081Kckwgy1glugjtu5saj30d20ew0zb.jpg)

***

## 最终数据集展示

```{r}
data <- read.csv("预处理后数据.csv")
data$销售年份 <- as.character(data$销售年份)

# 删除一些变量
data <- data[-c(2, 3, 13, 14)]

# 抽2000间房产作为样本
set.seed(2020)
samples1 <- sample(1:nrow(data), 2000)
data1 <- data[samples1, ]

kable(head(data1))  # 展示前6行数据
```

***

# 模型建立

## 模型一：全变量回归

```{r}
fit.1 <- lm(formula = log(销售价格) ~ 居住面积 + 土地面积 + 楼层数 + 视野 + 成色 + 建筑设计水平 + 建筑年份 + 纬度 + 经度 + 每间卧室平均浴室数 + 有无地下室 + 距最近优质啤酒厂的距离 + 距医院的交通距离 + 销售年份 + 销售季度 + 是否位于西雅图 + 最近一次翻新距今年份 + 是否邻近海岸, data = data1)
summary(fit.1)
```

***

## 自变量筛选（逐步回归）

```{r}
fit.2 <- step(fit.1)
```

***

## 模型二：部分变量回归

```{r}
summary(fit.2)
```

***

## 回归诊断

```{r}
regression.diagnostics(fit.2)
```

联系异常值/强影响点检验、残差与真实值关系图（Residuals vs Fitted）以及COOK距离图，删去点823、5416、10082和9259对应数据。

对于异方差检验，p值大于0.05，故近似认为异方差性不存在。

共线性检验中，所有变量的VIF值均小于10，相对较高的是建筑年份（8.032101）和最近一次翻新距今年份的VIF值（8.014117），其原因可能在于两者都是时间变量，存在一定相关性。这里删去翻新距今年份的自变量。

对于自相关检验，自相关系数近似为0，DW统计量也趋近于2，故近似认为不存在自相关。

***

## 模型三：诊断、处理后重新回归

```{r}
#除去异常值点
data2 <- data[-c(823, 5416, 10082, 9259), ]

# 抽2000间房产作为样本
set.seed(2020)
samples2 <- sample(1:nrow(data2), 2000)
data2 <- data2[samples2, ]

fit.3 <- lm(formula = log(销售价格) ~ 居住面积 + 楼层数 + 视野 + 成色 + 建筑设计水平 + 建筑年份 + 经度 + 每间卧室平均浴室数 + 距最近优质啤酒厂的距离 +  距医院的交通距离 + 销售年份 + 销售季度 + 是否位于西雅图 + 是否邻近海岸, data = data2)
summary(fit.3)

#逐步回归
fit.3 <- step(fit.3)
summary(fit.3)

#回归诊断
regression.diagnostics(fit.3)
```

经过上述处理，异方差检验和自相关检验仍然通过，且自相关DW统计量更趋近于2。
    
共线性有所改善，建筑年份的VIF值从8.032101降到2.784103，且其他所有自变量的VIF值均小于8。
    
R^2也有较为明显的提升。（从0.7848到0.8071）

***

## 平方项设计

通过观察各项变量与因变量之间的散点图/箱线图，观察有没有先高后低/先低后高的情况，据此设计了两个平方项。

#### (楼层数-2)^2

```{r}
par(family = "PingFang SC")  # 设置中文字体
plot(as.factor(data$楼层数), log(data$销售价格), xlab = "楼层数", ylab = "log(销售价格)")
```

#### (纬度-47.65)^2

```{r}
par(family = "PingFang SC")  # 设置中文字体
plot(data$纬度, log(data$销售价格), xlab = "纬度", ylab = "log(销售价格)")
```

***

## 模型四：尝试加入平方项

自变量选择、回归诊断等步骤同上，此处省略，直接展示最终模型的结果。

```{r}
#除去异常值点
data3 <- data[-c(1740, 11431, 11492), ]

# 抽2000间房产作为样本
set.seed(2020)
samples3 <- sample(1:nrow(data3), 2000)
data3 <- data3[samples3, ]

fit.4 <- lm(formula = log(销售价格) ~ 居住面积 + 土地面积 + I((楼层数-2.5)^2) + 视野 + 成色 + 建筑设计水平 + 建筑年份 + I((纬度-47.65)^2) + 经度 + 每间卧室平均浴室数 + 有无地下室 + 距最近优质啤酒厂的距离 + 距医院的交通距离 + 销售年份 + 销售季度 + 是否位于西雅图 + 是否邻近海岸, data = data3)
summary(fit.4)

#逐步回归
fit.4 <- step(fit.4)
summary(fit.4)

#回归诊断
regression.diagnostics(fit.4)
```

模型四与模型三相比，绝大部分变量跑出来系数的正负都是相同的。模型诊断方面，异方差检验变好了，共线性的最大VIF值降低了，自相关检验也更好了，但R方有一定的降低。总体来讲，两个模型解释起来并无冲突，可以相互印证。

***

# 模型解释

### 对房价无明显影响的变量

在逐步回归中被去掉，或未被去掉但在最终模型中不显著的变量，被视作对房价无明显影响。

1. 有无地下室：地下室对房价的影响并不明显，人们对地下室即不偏好也不偏恶。
2. 土地面积：房屋附带的土地面积对房价并没有显著影响，大家还是更关注房子本身的环境和条件。
3. 纬度：与我们的预想不同的是，虽然箱线图中表现出纬度与房价有近似二次函数的关联，但其实无论是在模型三还是模型四中，这种关联都并不显著。这也许是因为纬度的信息蕴含在了距最近优质啤酒厂的距离、距医院的交通距离、是否邻近海岸等其他变量中。例如，从前面的地图中可以看出，海景房比较集中于北部，且医院和啤酒厂也处于中间偏北。

### 对房价有正向影响的变量

1. 居住面积：居住面积越大的房子越大，这很符合常理。
2. 楼层数：人们总体上更喜欢楼层数高的房子，且2.5层是最合理的楼层设置，即两层加一个阁楼。
3. 视野：人们喜欢视野更好的房子。
4. 成色：人们喜欢成色更新的房子。
5. 建筑设计水平：人们喜欢建筑设计水平更高的房子，且程度比较高。（因为回归系数比较大）
6. 经度：在金县区域内，偏东部的房价更高。
7. 销售年份2015：15年的房价总体比14年有上涨。
8. 销售季度Q2、Q3、Q4：房价总体上是Q2 > Q3 > Q4 > Q1。
9. 是否邻近海岸：人们更喜欢靠近海边的房子。

### 对房价有负向影响的变量

1. 建筑年份：人们更喜欢老房子。
2. 每间卧室平均浴室数：人们不需要每间卧室配那么多浴室，少量够用的水平即可。
3. 距最近优质啤酒厂的距离：人们更喜欢住的离优质啤酒厂更近，在夜晚和周末享受优质的生活体验。
4. 距医院的交通距离：人们更喜欢住的离医院更近，让自己的生活更有保障。（不排除是医院附近有学校、商业街等其他原因导致）
5. 是否位于西雅图是：与我们的预想不同的是，西雅图的房价比其他地区要低。这可能有几个原因：一是用邮编来刻画一个房产是否地处西雅图仍存在一些偏差，二是此回归系数仅表示在其他变量不变时，处于西雅图的房子比不处于西雅图的房子更贵，但西雅图的房子通常离优质啤酒厂更近，离医院也更近，即难以无法控制其他变量不变，所以西雅图房价其实并不低。
